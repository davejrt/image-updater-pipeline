# Code generated by dhall-to-yaml.  DO NOT EDIT.
steps:
    - commands:
          - ".buildkite/image-updater/scripts/clean-branch-if-exists.sh"
      concurrency: 1
      concurrency_group: sourcegraph/image-updater-pipeline/update-images
      env:
          TARGET_BRANCH: update-docker-images/images
      key: start_gate
      label: ":broom: :git: cleanup old branch"
      retry:
          manual:
              allowed: false
              permit_on_passed: false
              reason: "Sorry, queue up a new build instead (we don't want to build from outdated commits)."
    - wait: "~"
    - commands:
          - ".buildkite/image-updater/scripts/update-all-images.sh"
      concurrency: 1
      concurrency_group: sourcegraph/image-updater-pipeline/update-images
      depends_on:
          - start_gate
      key: stage-srcimg
      label: ":bash: :k8s: commit 'srcimg' changes"
      plugins:
          - "thedyrt/git-commit#v0.3.0":
                add: "."
                branch: update-docker-images/images
                create-branch: "true"
                message: |
                    Update Docker images to ${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}

                    Links:

                    [Commit]
                    - sourcegraph: https://sourcegraph.com/github.com/sourcegraph/sourcegraph/-/commit/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
                    - github: https://github.com/sourcegraph/sourcegraph/commit/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}

                    [Tree]
                    - sourcegraph: https://sourcegraph.com/github.com/sourcegraph/sourcegraph@${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
                    - github: https://github.com/sourcegraph/sourcegraph/tree/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
                remote: origin
      retry:
          manual:
              allowed: false
              permit_on_passed: false
              reason: "Sorry, queue up a new build instead (we don't want to build from outdated commits)."
    - wait: "~"
    - commands:
          - ".buildkite/image-updater/scripts/create-pr.sh"
      concurrency: 1
      concurrency_group: sourcegraph/image-updater-pipeline/update-images
      depends_on:
          - stage-srcimg
      env:
          BODY: |
              Update Docker images to ${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}

              Links:

              [Commit]
              - sourcegraph: https://sourcegraph.com/github.com/sourcegraph/sourcegraph/-/commit/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
              - github: https://github.com/sourcegraph/sourcegraph/commit/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}

              [Tree]
              - sourcegraph: https://sourcegraph.com/github.com/sourcegraph/sourcegraph@${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
              - github: https://github.com/sourcegraph/sourcegraph/tree/${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}
          HEAD: update-docker-images/images
          TITLE: "Update Docker images to ${TARGET_COMMIT?is not set. Please specify the sourcegraph/sourcegraph commit that you would like to be deployed.}"
      key: stage-create-pr
      label: ":github: Open Pull Request"
      retry:
          manual:
              allowed: false
              permit_on_passed: false
              reason: "Sorry, queue up a new build instead (we don't want to build from outdated commits)."
